<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>مدیریت ثبت محموله خودروهای مزایده</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      background: #f6f8fa;
      font-family: 'Vazirmatn', Tahoma, Arial, sans-serif;
      margin: 0;
      padding: 32px;
      line-height: 1.5;
    }

    .container {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: 18px 16px 22px 16px;
      max-width: 1100px;
      margin: auto;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      border-bottom: 1px solid #e4e8ef;
      padding-bottom: 15px;
    }

    .header h2 {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 0;
      color: #23272f;
      letter-spacing: -0.5px;
    }

    .btn-primary {
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 0.95rem;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(25,118,210,0.2);
      margin-right: 2px;
    }

    .btn-primary:hover {
      background: #1251a1;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(25,118,210,0.3);
    }

    .btn-secondary {
      background: #f8f9fa;
      color: #495057;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 0.95rem;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      font-weight: 500;
      margin-left: 10px;
    }

    .btn-secondary:hover {
      background: #e9ecef;
      border-color: #adb5bd;
    }

    .btn-success {
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 0.95rem;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
      font-weight: 500;
      margin-left: 10px;
    }

    .btn-success:hover {
      background: #218838;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      font-size: 0.95rem;
      box-shadow: none;
    }

    thead tr {
      background: #f6f8fa;
    }

    th, td {
      text-align: center;
      padding: 12px 8px;
      font-size: 0.95rem;
      color: #23272f;
      font-weight: 400;
      white-space: nowrap; /* Prevents text wrapping in table headers/cells */
    }

    th {
      color: #6b7685;
      font-weight: 500;
      font-size: 0.95rem;
      background: #f6f8fa;
      border-bottom: 1.5px solid #e4e8ef;
    }

    tbody tr {
      transition: background 0.12s;
      border-bottom: 1px solid #f1f3f4;
    }

    tbody tr:hover {
      background: #f1f5fa;
    }

    .actions {
      white-space: nowrap;
    }

    .actions button {
      background: none;
      border: none;
      cursor: pointer;
      margin: 0 3px;
      font-size: 1.08rem;
      transition: color 0.2s;
      vertical-align: middle;
      outline: none;
      padding: 5px;
      border-radius: 4px;
    }

    .actions .fa-eye { color: #2e7d32; }
    .actions .fa-trash { color: #d32f2f; }
    .actions .fa-pen { color: #1976d2; }
    .actions .fa-camera { color: #ffc107; } /* Style for camera icon */
    .actions button:hover { background: rgba(0,0,0,0.05); }
    .actions button:hover .fa-eye { color: #388e3c; }
    .actions button:hover .fa-trash { color: #b71c1c; }
    .actions button:hover .fa-pen { color: #0d47a1; }
    .actions button:hover .fa-camera { color: #e0a800; }

    /* Form Styles (for main new shipment form) */
    .form-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .form-tabs { /* This style is still used for the main new shipment form */
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid #e4e8ef;
      overflow-x: auto;
    }

    .tab-button { /* This style is still used for the main new shipment form */
      background: none;
      border: none;
      padding: 12px 20px;
      font-size: 0.95rem;
      font-family: inherit;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      color: #6b7685;
      font-weight: 500;
      white-space: nowrap;
    }

    .tab-button.active { /* This style is still used for the main new shipment form */
      color: #1976d2;
      border-bottom-color: #1976d2;
    }

    .tab-button:hover { /* This style is still used for the main new shipment form */
      color: #1976d2;
      background: rgba(25,118,210,0.05);
    }

    .tab-content { /* This style is still used for the main new shipment form */
      display: none;
    }

    .tab-content.active { /* This style is still used for the main new shipment form */
      display: block;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: 500;
      margin-bottom: 6px;
      color: #23272f;
      font-size: 0.95rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 10px 12px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 0.95rem;
      font-family: inherit;
      transition: border-color 0.2s;
      background: #fff;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #1976d2;
      box-shadow: 0 0 0 2px rgba(25,118,210,0.1);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #e4e8ef;
    }

    .upload-area {
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      background: #f8f9fa;
      transition: all 0.2s;
      margin-bottom: 20px;
    }

    .upload-area:hover {
      border-color: #1976d2;
      background: rgba(25,118,210,0.02);
    }

    .upload-area i {
      font-size: 2rem;
      color: #6b7685;
      margin-bottom: 10px;
    }

    .file-upload-section {
      text-align: center;
      padding: 40px 20px;
    }

    .file-upload-section h3 {
      color: #23272f;
      margin-bottom: 15px;
    }

    .file-upload-section p {
      color: #6b7685;
      margin-bottom: 25px;
    }

    .download-template {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #28a745;
      color: white;
      text-decoration: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
      margin-bottom: 25px;
    }

    .download-template:hover {
      background: #218838;
      text-decoration: none;
      color: white;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .breadcrumb {
      margin-bottom: 20px;
      color: #6b7685;
      font-size: 0.9rem;
    }

    .breadcrumb a {
      color: #1976d2;
      text-decoration: none;
    }

    .breadcrumb a:hover {
      text-decoration: underline;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }

    .details-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e4e8ef;
    }

    .details-info div {
        background: #f8f9fa;
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .details-info strong {
        color: #23272f;
        display: block;
        margin-bottom: 5px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .details-info span {
        color: #495057;
        font-size: 0.95rem;
    }

    .scrollable-table-container {
        overflow-x: auto;
        width: 100%;
        margin-top: 20px;
        margin-bottom: 20px;
    }

    .scrollable-table-container table {
        width: max-content; /* Ensure table takes full width of content */
        min-width: 100%; /* Fallback for smaller content */
    }

    .scrollable-table-container input[type="text"],
    .scrollable-table-container select,
    .scrollable-table-container textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 0.9rem;
        font-family: inherit;
        transition: border-color 0.2s;
        background: #fff;
    }

    .scrollable-table-container input[type="text"]:focus,
    .scrollable-table-container select:focus,
    .scrollable-table-container textarea:focus {
      outline: none;
      border-color: #1976d2;
      box-shadow: 0 0 0 2px rgba(25,118,210,0.1);
    }

    /* Styles for the new add vehicle forms within details page */
    #singleVehicleAddFormContainer, #fileVehicleAddContainer {
        display: none; /* Initially hidden, controlled by JS toggle */
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #e4e8ef;
        border-radius: 8px;
        background-color: #fcfdff;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }

    #singleVehicleAddFormContainer .form-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .add-vehicle-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px; /* Placed below the general details grid and table */
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e4e8ef;
        justify-content: flex-start; /* Aligns buttons to the left */
    }

    /* Styles for editable table rows (main shipment table & vehicle details table) */
    table tr.editing {
        background-color: #e6f7ff; /* Light blue background for editing row */
    }

    table tr.editing .display-mode {
        display: none; /* Hide static text when editing */
    }

    table tr.editing .edit-mode {
        display: block; /* Show input fields when editing */
        width: 100%;
    }

    table td .display-mode {
        display: block; /* Show static text by default */
    }

    table td .edit-mode {
        display: none; /* Hide input fields by default */
    }

    .actions-view {
        display: flex; /* Always show view actions by default */
        justify-content: center;
        align-items: center;
        gap: 5px;
    }
    table tr.editing .actions-view {
        display: none; /* Hide view actions when editing */
    }

    .actions-edit {
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        gap: 5px;
    }
    table tr.editing .actions-edit {
        display: flex; /* Show edit actions when editing */
    }

    .actions-edit button {
      padding: 6px 10px;
      font-size: 0.85rem;
      border-radius: 4px;
      font-weight: 500;
      margin: 0 2px; /* Adjust margin for buttons */
    }

    .actions-edit .btn-save-row {
      background: #1976d2;
      color: #fff;
    }
    .actions-edit .btn-save-row:hover {
      background: #1251a1;
    }

    .actions-edit .btn-cancel-row {
      background: #6c757d;
      color: #fff;
    }
    .actions-edit .btn-cancel-row:hover {
      background: #5a6268;
    }


    @media (max-width: 768px) {
      .container {
        padding: 12px;
        margin: 16px;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      th, td {
        font-size: 0.9rem;
        padding: 8px 4px;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
      .form-actions {
        flex-direction: column;
      }
      .form-tabs {
        overflow-x: auto;
      }
      .details-info {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="mainPage" class="page active">
    <div class="container">
      <div class="header">
        <h2>مدیریت ثبت محموله خودروهای مزایده</h2>
        <button class="btn-primary" onclick="showNewItemPage()">
          <i class="fa fa-plus"></i> ثبت مورد جدید (محموله)
        </button>
      </div>
      <table>
        <thead>
          <tr>
            <th>شماره محموله</th>
            <th>شرح محموله</th>
            <th>تاریخ ثبت</th>
            <th>تامین کننده</th>
            <th>نوع ارسال</th>
            <th>تاریخ</th>
            <th>وضعیت</th>
            <th>عملیات</th>
          </tr>
        </thead>
        <tbody id="dataTable">
          </tbody>
      </table>
    </div>
  </div>

  <div id="newItemPage" class="page">
    <div class="container">
      <div class="breadcrumb">
        <a href="#" onclick="showMainPage()">مدیریت محموله</a> / ثبت مورد جدید (محموله)
      </div>

      <div class="header">
        <h2>ثبت مورد جدید (محموله)</h2>
        <button class="btn-secondary" onclick="showMainPage()">
          <i class="fa fa-arrow-right"></i> بازگشت
        </button>
      </div>

      <div class="form-container">
        <div class="form-tabs">
          <button class="tab-button active" onclick="showTab('single')">
            <i class="fa fa-plus-circle"></i> ثبت تکی محموله
          </button>
          <button class="tab-button" onclick="showTab('file')">
            <i class="fa fa-file-excel"></i> ثبت با فایل (محموله)
          </button>
        </div>

        <div id="singleTab" class="tab-content active">
          <form id="singleItemForm">
            <div class="form-grid">
              <div class="form-group">
                <label>تاریخ ثبت *</label>
                <input type="text" id="registerDate" readonly>
              </div>

              <div class="form-group">
                <label>شماره حواله *</label>
                <input type="text" id="invoiceNumber" placeholder="مثال: SHP-10046" required>
              </div>

              <div class="form-group">
                <label>شرح حواله *</label>
                <input type="text" id="invoiceDescription" placeholder="مثال: کوئیک پلاس نقره‌ای" required>
              </div>

              <div class="form-group">
                <label>تامین کننده *</label>
                <input type="text" id="supplier" placeholder="مثال: شرکت خودرو ساز" required>
              </div>

              <div class="form-group">
                <label>نوع ارسال *</label>
                <select id="shipmentType" required>
                  <option value="">انتخاب نوع ارسال</option>
                  <option value="امانی">امانی</option>
                  <option value="قطعی">قطعی</option>
                </select>
              </div>

              <div class="form-group">
                <label>تاریخ *</label>
                <input type="text" id="shipmentDate" placeholder="۱۴۰۴/۰۸/۲۵" required>
              </div>

              <div class="form-group">
                <label>وضعیت *</label>
                <select id="status" required>
                  <option value="">انتخاب وضعیت</option>
                  <option value="فعال">فعال</option>
                  <option value="غیرفعال">غیرفعال</option>
                </select>
              </div>
            </div>

            <div class="upload-area">
              <i class="fa fa-cloud-upload-alt"></i>
              <h4>آپلود فایل ضمیمه</h4>
              <p>فایل‌های مجاز: PDF, JPG, PNG</p>
              <input type="file" id="attachmentFile" accept=".pdf,.jpg,.jpeg,.png" style="display: none;">
              <button type="button" class="btn-secondary" onclick="document.getElementById('attachmentFile').click()">
                <i class="fa fa-upload"></i> انتخاب فایل
              </button>
              <div id="selectedFileName" style="margin-top: 10px; color: #28a745;"></div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-secondary" onclick="resetForm()">
                <i class="fa fa-undo"></i> پاک کردن
              </button>
              <button type="submit" class="btn-success">
                <i class="fa fa-save"></i> ثبت محموله جدید
              </button>
            </div>
          </form>
        </div>

        <div id="fileTab" class="tab-content">
          <div class="file-upload-section">
            <h3>ثبت دسته‌ای محموله با فایل Excel</h3>
            <p>ابتدا فایل نمونه را دانلود کرده و اطلاعات خود را وارد نمایید</p>

            <a href="#" class="download-template" onclick="downloadTemplate()">
              <i class="fa fa-download"></i>
              دانلود فایل نمونه Excel (محموله)
            </a>

            <div class="upload-area">
              <i class="fa fa-file-excel"></i>
              <h4>آپلود فایل Excel تکمیل شده (محموله)</h4>
              <p>فرمت مجاز: .xlsx, .xls</p>
              <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelFile(this)">
              <button type="button" class="btn-primary" onclick="document.getElementById('excelFile').click()">
                <i class="fa fa-upload"></i> انتخاب فایل Excel
              </button>
              <div id="excelFileName" style="margin-top: 10px; color: #28a745;"></div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-success" id="uploadExcelBtn" style="display: none;" onclick="uploadExcelData()">
                <i class="fa fa-check"></i> ثبت اطلاعات فایل
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="shipmentDetailsPage" class="page">
    <div class="container">
      <div class="breadcrumb">
        <a href="#" onclick="showMainPage()">مدیریت محموله</a> / <span id="currentShipmentIdBreadcrumb">جزئیات محموله</span>
      </div>

      <div class="header">
        <h2 id="detailsShipmentTitle">جزئیات محموله</h2> <button class="btn-secondary" onclick="showMainPage()">
          <i class="fa fa-arrow-right"></i> بازگشت
        </button>
      </div>

      <div class="details-info" id="generalShipmentDetails">
        </div>

      <div class="scrollable-table-container">
        <table id="vehicleDetailsTable">
          <thead>
            <tr>
              <th>هدر محموله</th>
              <th>وضعیت خودرو</th>
              <th>قیمت کارشناسی سایپا</th>
              <th>هزینه آپشن</th>
              <th>هزینه خلافی</th>
              <th>هزینه تعمیر و نگهداری</th>
              <th>هزینه حمل و نقل</th>
              <th>هزینه عوارض شهرداری</th>
              <th>بهای تمام شده</th>
              <th>شماره هرم</th>
              <th>نام خودرو</th>
              <th>گروه خودرو</th>
              <th>توضیحات محل آسیب دیده خودرو</th>
              <th>ایرادات موتور خودرو</th>
              <th>ایرادات بدنه</th>
              <th>موقعیت پارکینگ</th>
              <th>راهنمای ثبت قیمت</th>
              <th>اطلاعی ندارم (قیمت)</th>
              <th>تعداد</th>
              <th>واحد شمارش</th>
              <th>مبلغ سپرده</th>
              <th>حداقل قیمت پیشنهادی</th>
              <th>حداکثر قیمت فروش</th>
              <th>ای دی جدول خودرو</th>
              <th>شماره ساخت</th>
              <th>شاسی</th>
              <th>موتور</th>
              <th>سال</th>
              <th>رنگ</th>
              <th>پلاک</th>
              <th>تاریخ اتمام بیمه</th>
              <th>اطلاعی ندارم (بیمه)</th>
              <th>کیلومتر</th>
              <th>اطلاعی ندارم (کیلومتر)</th>
              <th>عملیات</th> </tr>
          </thead>
          <tbody id="vehicleDetailsTableBody">
            </tbody>
        </table>
      </div>

      <div class="add-vehicle-actions">
        <button class="btn-primary" id="toggleAddVehicleFormBtn" onclick="toggleAddVehicleForm()">
          <i class="fa fa-plus"></i> ثبت مورد جدید (خودرو)
        </button>
        <button class="btn-primary" id="toggleExcelVehicleAddBtn" onclick="toggleExcelVehicleAdd()">
          <i class="fa fa-file-excel"></i> ثبت با فایل (خودرو)
        </button>
      </div>

      <div id="singleVehicleAddFormContainer">
        <form id="singleVehicleForm">
          <div class="form-grid">
            <div class="form-group">
                <label for="newVehicleHeader">هدر محموله *</label>
                <input type="text" id="newVehicleHeader" placeholder="مثال: SHP-10045-3" required>
            </div>
            <div class="form-group">
                <label for="newVehicleStatus">وضعیت خودرو *</label>
                <select id="newVehicleStatus" required>
                    <option value="">انتخاب وضعیت</option>
                    <option value="پارکینگ">پارکینگ</option>
                    <option value="مزایده">مزایده</option>
                    <option value="نهایی">نهایی</option>
                </select>
            </div>
            <div class="form-group">
                <label for="newAppraisalPrice">قیمت کارشناسی سایپا</label>
                <input type="text" id="newAppraisalPrice" placeholder="مثال: 850,000,000">
            </div>
            <div class="form-group">
                <label for="newOtherCostsOption">سایر هزینه‌های: آپشن</label>
                <input type="text" id="newOtherCostsOption" placeholder="مثال: 500,000">
            </div>
            <div class="form-group">
                <label for="newOtherCostsViolation">سایر هزینه‌های: خلافی</label>
                <input type="text" id="newOtherCostsViolation" placeholder="مثال: 100,000">
            </div>
            <div class="form-group">
                <label for="newOtherCostsMaintenance">سایر هزینه‌های: تعمیر و نگهداری</label>
                <input type="text" id="newOtherCostsMaintenance" placeholder="مثال: 12,500,000">
            </div>
            <div class="form-group">
                <label for="newOtherCostsTransport">سایر هزینه‌های: حمل و نقل</label>
                <input type="text" id="newOtherCostsTransport" placeholder="مثال: 2,000,000">
            </div>
            <div class="form-group">
                <label for="newOtherCostsMunicipalTax">سایر هزینه‌های: عوارض شهرداری</label>
                <input type="text" id="newOtherCostsMunicipalTax" placeholder="مثال: 50,000">
            </div>
            <div class="form-group">
                <label for="newFinalPrice">بهای تمام شده</label>
                <input type="text" id="newFinalPrice" placeholder="مثال: 865,650,000">
            </div>
            <div class="form-group">
                <label for="newPyramidNumber">شماره هرم *</label>
                <input type="text" id="newPyramidNumber" placeholder="مثال: A-125" required>
            </div>
            <div class="form-group">
                <label for="newCarName">نام خودرو *</label>
                <input type="text" id="newCarName" placeholder="مثال: شاهین" required>
            </div>
            <div class="form-group">
                <label for="newCarGroup">گروه خودرو</label>
                <input type="text" id="newCarGroup" placeholder="مثال: گروه سایپا>
            </div>
            <div class="form-group">
                <label for="newDamageDescription">توضیحات محل آسیب دیده خودرو</label>
                <textarea id="newDamageDescription" placeholder="توضیحات آسیب‌ها..."></textarea>
            </div>
            <div class="form-group">
                <label for="newEngineIssues">ایرادات موتور خودرو</label>
                <textarea id="newEngineIssues" placeholder="ایرادات موتور..."></textarea>
            </div>
            <div class="form-group">
                <label for="newBodyIssues">ایرادات بدنه</label>
                <textarea id="newBodyIssues" placeholder="ایرادات بدنه..."></textarea>
            </div>
            <div class="form-group">
                <label for="newParkingLocation">موقعیت پارکینگ</label>
                <input type="text" id="newParkingLocation" placeholder="مثال: پارکینگ ۴، ردیف ۱۰">
            </div>
            <div class="form-group">
                <label for="newPriceGuide">راهنمای ثبت قیمت</label>
                <input type="text" id="newPriceGuide" placeholder="راهنمای قیمت‌گذاری">
            </div>
            <div class="form-group">
                <label for="newPriceInfoUnknown">اطلاعی ندارم (قیمت)</label>
                <select id="newPriceInfoUnknown">
                    <option value="خیر">خیر</option>
                    <option value="بله">بله</option>
                </select>
            </div>
            <div class="form-group">
                <label for="newQuantity">تعداد</label>
                <input type="text" id="newQuantity" value="1">
            </div>
            <div class="form-group">
                <label for="newUnit">واحد شمارش</label>
                <input type="text" id="newUnit" value="دستگاه">
            </div>
            <div class="form-group">
                <label for="newDepositAmount">مبلغ سپرده</label>
                <input type="text" id="newDepositAmount" placeholder="مثال: 50,000,000">
            </div>
            <div class="form-group">
                <label for="newMinBidPrice">حداقل قیمت پیشنهادی</label>
                <input type="text" id="newMinBidPrice" placeholder="مثال: 800,000,000">
            </div>
            <div class="form-group">
                <label for="newMaxSalePrice">حداکثر قیمت فروش</label>
                <input type="text" id="newMaxSalePrice" placeholder="مثال: 900,000,000">
            </div>
            <div class="form-group">
                <label for="newVehicleId">ای دی جدول خودرو (سیستم تولید می‌کند)</label>
                <input type="text" id="newVehicleId" readonly placeholder="مثال: VEH-003">
            </div>
            <div class="form-group">
                <label for="newBuildNumber">شماره ساخت</label>
                <input type="text" id="newBuildNumber" placeholder="مثال: BN-12345">
            </div>
            <div class="form-group">
                <label for="newChassis">شاسی</label>
                <input type="text" id="newChassis" placeholder="مثال: CH-XYZ-98765">
            </div>
            <div class="form-group">
                <label for="newEngine">موتور</label>
                <input type="text" id="newEngine" placeholder="مثال: EN-UVW-54321">
            </div>
            <div class="form-group">
                <label for="newYear">سال</label>
                <input type="text" id="newYear" placeholder="مثال: 1400">
            </div>
            <div class="form-group">
                <label for="newColor">رنگ</label>
                <input type="text" id="newColor" placeholder="مثال: نقره‌ای">
            </div>
            <div class="form-group">
                <label for="newPlate">پلاک</label>
                <input type="text" id="newPlate" placeholder="مثال: ایران ۱۱-۷۸۹ الف ۰۱">
            </div>
            <div class="form-group">
                <label for="newInsuranceEndDate">تاریخ اتمام بیمه</label>
                <input type="text" id="newInsuranceEndDate" placeholder="مثال: ۱۴۰۵/۰۵/۲۰">
            </div>
            <div class="form-group">
                <label for="newInsuranceInfoUnknown">اطلاعی ندارم (بیمه)</label>
                <select id="newInsuranceInfoUnknown">
                    <option value="خیر">خیر</option>
                    <option value="بله">بله</option>
                </select>
            </div>
            <div class="form-group">
                <label for="newMileage">کیلومتر</label>
                <input type="text" id="newMileage" placeholder="مثال: 75000">
            </div>
            <div class="form-group">
                <label for="newMileageInfoUnknown">اطلاعی ندارم (کیلومتر)</label>
                <select id="newMileageInfoUnknown">
                    <option value="خیر">خیر</option>
                    <option value="بله">بله</option>
                </select>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="resetNewVehicleForm()">
              <i class="fa fa-undo"></i> پاک کردن
            </button>
            <button type="submit" class="btn-success">
              <i class="fa fa-save"></i> ذخیره (افزودن خودرو)
            </button>
          </div>
        </form>
      </div>

      <div id="fileVehicleAddContainer">
        <div class="file-upload-section">
          <h3>ثبت دسته‌ای خودرو با فایل Excel</h3>
          <p>ابتدا فایل نمونه را دانلود کرده و اطلاعات خودروها را وارد نمایید</p>

          <a href="#" class="download-template" onclick="downloadVehicleTemplate()">
            <i class="fa fa-download"></i>
            دانلود فایل نمونه Excel (خودرو)
          </a>

          <div class="upload-area">
            <i class="fa fa-file-excel"></i>
            <h4>آپلود فایل Excel تکمیل شده (خودرو)</h4>
            <p>فرمت مجاز: .xlsx, .xls</p>
            <input type="file" id="excelVehicleFile" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelVehicleFile(this)">
            <button type="button" class="btn-primary" onclick="document.getElementById('excelVehicleFile').click()">
              <i class="fa fa-upload"></i> انتخاب فایل Excel
            </button>
            <div id="excelVehicleFileName" style="margin-top: 10px; color: #28a745;"></div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-success" id="uploadVehicleExcelBtn" style="display: none;" onclick="uploadVehicleExcelData()">
              <i class="fa fa-check"></i> ثبت اطلاعات فایل
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // متغیرهای سراسری (شامل داده‌های نمونه بروزرسانی شده با جزئیات خودروها)
    let shipmentData = [
      {
        id: 'SHP-10045',
        description: 'ساینا سفید',
        registerDate: '۱۴۰۴/۰۸/۱۵',
        supplier: 'شرکت پارس خودرو',
        shipmentType: 'امانی',
        date: '۱۴۰۴/۰۸/۲۰',
        status: 'فعال',
        vehicles: [
          {
            vehicleId: 'VEH-001',
            header: 'SHP-10045-1',
            vehicleStatus: 'پارکینگ',
            appraisalPrice: '850000000',
            otherCostsOption: '500000',
            otherCostsViolation: '100000',
            otherCostsMaintenance: '12500000',
            otherCostsTransport: '2000000',
            otherCostsMunicipalTax: '50000',
            finalPrice: '865650000',
            pyramidNumber: 'A-123',
            carName: 'پراید 131',
            carGroup: 'گروه سایپا',
            damageDescription: 'خط و خش جزئی روی کاپوت',
            engineIssues: 'صدای غیرعادی از موتور',
            bodyIssues: 'فرورفتگی در گلگیر عقب',
            parkingLocation: 'پارکینگ شماره ۳، ردیف ۵',
            priceGuide: 'بر اساس قیمت مصوب کارخانه',
            priceInfoUnknown: 'خیر',
            quantity: '1',
            unit: 'دستگاه',
            depositAmount: '50000000',
            minBidPrice: '800000000',
            maxSalePrice: '900000000',
            buildNumber: 'B-7890',
            chassis: 'CH-XYZ-12345',
            engine: 'EN-ABC-67890',
            year: '1398',
            color: 'سفید',
            plate: 'ایران ۶۶-۱۱۲ ب ۳۴',
            insuranceEndDate: '۱۴۰۵/۰۱/۱۰',
            insuranceInfoUnknown: 'خیر',
            mileage: '125000',
            mileageInfoUnknown: 'خیر'
          },
          {
            vehicleId: 'VEH-002',
            header: 'SHP-10045-2',
            vehicleStatus: 'مزایده',
            appraisalPrice: '920000000',
            otherCostsOption: '0',
            otherCostsViolation: '0',
            otherCostsMaintenance: '15800000',
            otherCostsTransport: '2500000',
            otherCostsMunicipalTax: '70000',
            finalPrice: '938370000',
            pyramidNumber: 'A-124',
            carName: 'تیبا 2',
            carGroup: 'گروه سایپا',
            damageDescription: 'بدون آسیب ظاهری',
            engineIssues: 'روغن‌ریزی جزئی',
            bodyIssues: 'صحیح و سالم',
            parkingLocation: 'پارکینگ شماره ۲، ردیف ۱۲',
            priceGuide: 'بر اساس قیمت بازار آزاد',
            priceInfoUnknown: 'خیر',
            quantity: '1',
            unit: 'دستگاه',
            depositAmount: '60000000',
            minBidPrice: '850000000',
            maxSalePrice: '950000000',
            buildNumber: 'C-1234',
            chassis: 'CH-UVW-54321',
            engine: 'EN-DEF-98765',
            year: '1399',
            color: 'مشکی',
            plate: 'ایران ۲۲-۳۴۵ ج ۵۶',
            insuranceEndDate: '۱۴۰۴/۱۲/۲۹',
            insuranceInfoUnknown: 'خیر',
            mileage: '80000',
            mileageInfoUnknown: 'خیر'
          }
        ]
      },
      {
        id: 'SHP-10044',
        description: 'تیبا مشکی',
        registerDate: '۱۴۰۴/۰۸/۱۰',
        supplier: 'شرکت سایپا',
        shipmentType: 'قطعی',
        date: '۱۴۰۴/۱۰/۰۱',
        status: 'غیرفعال',
        vehicles: [] // No vehicles for this sample shipment initially
      }
    ];

    let currentShipmentForDetails = null; // To keep track of the shipment being viewed
    let editingMainRow = null; // To keep track of the main shipment row currently being edited
    let editingVehicleRow = null; // To keep track of the vehicle row currently being edited

    // اعداد فارسی
    function toPersianNumbers(num) {
      const persianDigits = '۰۱۲۳۴۵۶۷۸۹';
      if (num === null || num === undefined || num === '') return '';
      // Ensure it's treated as a number for locale-specific formatting
      let formattedNum = new Intl.NumberFormat('fa-IR').format(num);
      return formattedNum;
    }

    // تبدیل اعداد فارسی به انگلیسی (برای ذخیره در دیتا)
    function toEnglishNumbers(str) {
        if (str === null || str === undefined || str === '') return '';
        return str.toString().replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d)).replace(/,/g, '');
    }

    // تاریخ فارسی
    function getCurrentPersianDate() {
      const now = new Date();
      // For accurate Persian dates, a dedicated library like 'jalaali-js' or 'persian-date' is recommended.
      // This is a simplified function for basic demonstration.
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return toPersianNumbers(`${year}/${month}/${day}`);
    }

    // نمایش صفحات
    function showMainPage() {
      document.getElementById('mainPage').classList.add('active');
      document.getElementById('newItemPage').classList.remove('active');
      document.getElementById('shipmentDetailsPage').classList.remove('active');
      updateTable(); // Refresh table data on returning to main page
    }

    function showNewItemPage() {
      document.getElementById('mainPage').classList.remove('active');
      document.getElementById('newItemPage').classList.add('active');
      document.getElementById('shipmentDetailsPage').classList.remove('active');
      // Set register date for new shipment form
      const registerDateInput = document.getElementById('registerDate');
      if (registerDateInput) {
        registerDateInput.value = getCurrentDate();
        registerDateInput.setAttribute('readonly', 'true'); // Ensure it's readonly
      }
    }

    // نمایش صفحه جزئیات محموله
    function showShipmentDetails(shipmentId) {
      document.getElementById('mainPage').classList.remove('active');
      document.getElementById('newItemPage').classList.remove('active');
      document.getElementById('shipmentDetailsPage').classList.add('active');

      const shipment = shipmentData.find(item => item.id === shipmentId);
      if (!shipment) {
        alert('محموله مورد نظر یافت نشد.');
        showMainPage();
        return;
      }
      currentShipmentForDetails = shipment; // Set current shipment
      editingVehicleRow = null; // Reset vehicle editing state

      // Update breadcrumb and title
      document.getElementById('currentShipmentIdBreadcrumb').textContent = `جزئیات محموله: ${shipment.id}`;
      document.getElementById('detailsShipmentTitle').textContent = `جزئیات محموله: ${shipment.id}`;

      // Populate general shipment details
      const generalDetailsDiv = document.getElementById('generalShipmentDetails');
      generalDetailsDiv.innerHTML = `
        <div><strong>شماره محموله:</strong> <span>${shipment.id}</span></div>
        <div><strong>شرح محموله:</strong> <span>${shipment.description}</span></div>
        <div><strong>تاریخ ثبت:</strong> <span>${shipment.registerDate}</span></div>
        <div><strong>تامین کننده:</strong> <span>${shipment.supplier}</span></div>
        <div><strong>نوع ارسال:</strong> <span>${shipment.shipmentType}</span></div>
        <div><strong>تاریخ:</strong> <span>${shipment.date}</span></div>
        <div><strong>وضعیت:</strong> <span class="status-badge ${shipment.status === 'فعال' ? 'status-active' : 'status-inactive'}">${shipment.status}</span></div>
      `;

      renderVehicleDetailsTable(shipment.vehicles); // Render the vehicle table
      hideAllVehicleAddSections(); // Hide add forms initially when details page opens
    }

    // Render/Re-render the vehicle details table
    function renderVehicleDetailsTable(vehicles) {
      const vehicleTableBody = document.getElementById('vehicleDetailsTableBody');
      vehicleTableBody.innerHTML = ''; // Clear previous entries

      if (vehicles && vehicles.length > 0) {
        vehicles.forEach(vehicle => {
          const row = document.createElement('tr');
          row.setAttribute('data-vehicle-id', vehicle.vehicleId); // Add data-id for easier access

          row.innerHTML = `
            <td><span class="display-mode">${vehicle.header || ''}</span><input type="text" class="edit-mode" value="${vehicle.header || ''}" data-field="header" disabled></td>
            <td>
                <span class="display-mode">${vehicle.vehicleStatus || ''}</span>
                <select class="edit-mode" data-field="vehicleStatus" disabled>
                    <option value="پارکینگ" ${vehicle.vehicleStatus === 'پارکینگ' ? 'selected' : ''}>پارکینگ</option>
                    <option value="مزایده" ${vehicle.vehicleStatus === 'مزایده' ? 'selected' : ''}>مزایده</option>
                    <option value="نهایی" ${vehicle.vehicleStatus === 'نهایی' ? 'selected' : ''}>نهایی</option>
                </select>
            </td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.appraisalPrice)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.appraisalPrice)}" data-field="appraisalPrice" disabled></td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.otherCostsOption)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.otherCostsOption)}" data-field="otherCostsOption" disabled></td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.otherCostsViolation)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.otherCostsViolation)}" data-field="otherCostsViolation" disabled></td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.otherCostsMaintenance)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.otherCostsMaintenance)}" data-field="otherCostsMaintenance" disabled></td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.otherCostsTransport)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.otherCostsTransport)}" data-field="otherCostsTransport" disabled></td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.otherCostsMunicipalTax)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.otherCostsMunicipalTax)}" data-field="otherCostsMunicipalTax" disabled></td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.finalPrice)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.finalPrice)}" data-field="finalPrice" disabled></td>
            <td><span class="display-mode">${vehicle.pyramidNumber || ''}</span><input type="text" class="edit-mode" value="${vehicle.pyramidNumber || ''}" data-field="pyramidNumber" disabled></td>
            <td><span class="display-mode">${vehicle.carName || ''}</span><input type="text" class="edit-mode" value="${vehicle.carName || ''}" data-field="carName" disabled></td>
            <td><span class="display-mode">${vehicle.carGroup || ''}</span><input type="text" class="edit-mode" value="${vehicle.carGroup || ''}" data-field="carGroup" disabled></td>
            <td><span class="display-mode">${vehicle.damageDescription || ''}</span><textarea class="edit-mode" data-field="damageDescription" disabled>${vehicle.damageDescription || ''}</textarea></td>
            <td><span class="display-mode">${vehicle.engineIssues || ''}</span><textarea class="edit-mode" data-field="engineIssues" disabled>${vehicle.engineIssues || ''}</textarea></td>
            <td><span class="display-mode">${vehicle.bodyIssues || ''}</span><textarea class="edit-mode" data-field="bodyIssues" disabled>${vehicle.bodyIssues || ''}</textarea></td>
            <td><span class="display-mode">${vehicle.parkingLocation || ''}</span><input type="text" class="edit-mode" value="${vehicle.parkingLocation || ''}" data-field="parkingLocation" disabled></td>
            <td><span class="display-mode">${vehicle.priceGuide || ''}</span><input type="text" class="edit-mode" value="${vehicle.priceGuide || ''}" data-field="priceGuide" disabled></td>
            <td>
                <span class="display-mode">${vehicle.priceInfoUnknown || ''}</span>
                <select class="edit-mode" data-field="priceInfoUnknown" disabled>
                    <option value="خیر" ${vehicle.priceInfoUnknown === 'خیر' ? 'selected' : ''}>خیر</option>
                    <option value="بله" ${vehicle.priceInfoUnknown === 'بله' ? 'selected' : ''}>بله</option>
                </select>
            </td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.quantity)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.quantity)}" data-field="quantity" disabled></td>
            <td><span class="display-mode">${vehicle.unit || ''}</span><input type="text" class="edit-mode" value="${vehicle.unit || ''}" data-field="unit" disabled></td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.depositAmount)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.depositAmount)}" data-field="depositAmount" disabled></td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.minBidPrice)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.minBidPrice)}" data-field="minBidPrice" disabled></td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.maxSalePrice)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.maxSalePrice)}" data-field="maxSalePrice" disabled></td>
            <td><span class="display-mode">${vehicle.vehicleId || ''}</span><input type="text" class="edit-mode" value="${vehicle.vehicleId || ''}" data-field="vehicleId" readonly disabled></td>
            <td><span class="display-mode">${vehicle.buildNumber || ''}</span><input type="text" class="edit-mode" value="${vehicle.buildNumber || ''}" data-field="buildNumber" disabled></td>
            <td><span class="display-mode">${vehicle.chassis || ''}</span><input type="text" class="edit-mode" value="${vehicle.chassis || ''}" data-field="chassis" disabled></td>
            <td><span class="display-mode">${vehicle.engine || ''}</span><input type="text" class="edit-mode" value="${vehicle.engine || ''}" data-field="engine" disabled></td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.year)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.year)}" data-field="year" disabled></td>
            <td><span class="display-mode">${vehicle.color || ''}</span><input type="text" class="edit-mode" value="${vehicle.color || ''}" data-field="color" disabled></td>
            <td><span class="display-mode">${vehicle.plate || ''}</span><input type="text" class="edit-mode" value="${vehicle.plate || ''}" data-field="plate" disabled></td>
            <td><span class="display-mode">${vehicle.insuranceEndDate || ''}</span><input type="text" class="edit-mode" value="${vehicle.insuranceEndDate || ''}" data-field="insuranceEndDate" disabled></td>
            <td>
                <span class="display-mode">${vehicle.insuranceInfoUnknown || ''}</span>
                <select class="edit-mode" data-field="insuranceInfoUnknown" disabled>
                    <option value="خیر" ${vehicle.insuranceInfoUnknown === 'خیر' ? 'selected' : ''}>خیر</option>
                    <option value="بله" ${vehicle.insuranceInfoUnknown === 'بله' ? 'selected' : ''}>بله</option>
                </select>
            </td>
            <td><span class="display-mode">${toPersianNumbers(vehicle.mileage)}</span><input type="text" class="edit-mode" value="${toPersianNumbers(vehicle.mileage)}" data-field="mileage" disabled></td>
            <td>
                <span class="display-mode">${vehicle.mileageInfoUnknown || ''}</span>
                <select class="edit-mode" data-field="mileageInfoUnknown" disabled>
                    <option value="خیر" ${vehicle.mileageInfoUnknown === 'خیر' ? 'selected' : ''}>خیر</option>
                    <option value="بله" ${vehicle.mileageInfoUnknown === 'بله' ? 'selected' : ''}>بله</option>
                </select>
            </td>
            <td class="actions">
              <div class="actions-view">
                <button title="ویرایش" onclick="editVehicleRow(this, '${vehicle.vehicleId}')"><i class="fa fa-pen"></i></button>
                <button title="آپلود عکس" onclick="uploadVehicleImage('${vehicle.vehicleId}')"><i class="fa fa-camera"></i></button>
                <button title="حذف" onclick="deleteVehicleRow(this, '${vehicle.vehicleId}')"><i class="fa fa-trash"></i></button>
              </div>
              <div class="actions-edit">
                <button class="btn-save-row" title="ذخیره" onclick="saveEditedVehicleRow(this, '${vehicle.vehicleId}')"><i class="fa fa-save"></i> ذخیره</button>
                <button class="btn-cancel-row" title="لغو" onclick="cancelEditVehicleRow(this, '${vehicle.vehicleId}')"><i class="fa fa-times"></i> لغو</button>
              </div>
            </td>
          `;
          vehicleTableBody.appendChild(row);
        });
      } else {
        const noDataRow = document.createElement('tr');
        noDataRow.innerHTML = `<td colspan="35">اطلاعات خودرویی برای این محموله موجود نیست.</td>`;
        vehicleTableBody.appendChild(noDataRow);
      }
    }


    // تب‌ها (برای ثبت محموله جدید)
    function showTab(tabName) {
      document.querySelectorAll('#newItemPage .tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('#newItemPage .tab-content').forEach(content => content.classList.remove('active'));

      if (tabName === 'single') {
        document.querySelector('#newItemPage .tab-button:first-child').classList.add('active');
        document.getElementById('singleTab').classList.add('active');
      } else {
        document.querySelector('#newItemPage .tab-button:last-child').classList.add('active');
        document.getElementById('fileTab').classList.add('active');
      }
    }

    // مدیریت فرم ثبت محموله
    function resetForm() {
      document.getElementById('singleItemForm').reset();
      // Ensure registerDate is set automatically and is readonly
      const registerDateInput = document.getElementById('registerDate');
      if (registerDateInput) {
        registerDateInput.value = getCurrentPersianDate();
        registerDateInput.setAttribute('readonly', 'true');
      }
      document.getElementById('selectedFileName').textContent = '';
    }

    // مدیریت فایل ضمیمه محموله
    document.getElementById('attachmentFile').addEventListener('change', function() {
      const fileName = this.files[0] ? this.files[0].name : '';
      document.getElementById('selectedFileName').textContent = fileName ? `فایل انتخاب شده: ${fileName}` : '';
    });

    // ثبت فرم تکی محموله
    document.getElementById('singleItemForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const newShipmentId = document.getElementById('invoiceNumber').value;
      if (shipmentData.some(s => s.id === newShipmentId)) {
        alert('شماره محموله تکراری است. لطفاً شماره دیگری انتخاب کنید.');
        return;
      }

      const formData = {
        id: newShipmentId,
        description: document.getElementById('invoiceDescription').value,
        registerDate: document.getElementById('registerDate').value, // This is already readonly and auto-filled
        supplier: document.getElementById('supplier').value,
        shipmentType: document.getElementById('shipmentType').value,
        date: document.getElementById('shipmentDate').value,
        status: document.getElementById('status').value,
        vehicles: [] // New shipments start with no vehicles
      };

      shipmentData.push(formData);
      updateTable();
      alert('محموله جدید با موفقیت ثبت شد!');
      showMainPage();
      resetForm();
    });

    // به‌روزرسانی جدول محموله‌ها در صفحه اصلی
    function updateTable() {
      const tableBody = document.getElementById('dataTable');
      tableBody.innerHTML = '';

      shipmentData.forEach(item => {
        const row = document.createElement('tr');
        row.setAttribute('data-shipment-id', item.id); // Add data-id for main table rows

        const statusClass = item.status === 'فعال' ? 'status-active' : 'status-inactive';

        row.innerHTML = `
          <td><span class="display-mode">${item.id}</span><input type="text" class="edit-mode" value="${item.id}" data-field="id" disabled readonly></td>
          <td><span class="display-mode">${item.description}</span><input type="text" class="edit-mode" value="${item.description}" data-field="description" disabled></td>
          <td><span class="display-mode">${item.registerDate}</span><input type="text" class="edit-mode" value="${item.registerDate}" data-field="registerDate" disabled readonly></td>
          <td><span class="display-mode">${item.supplier}</span><input type="text" class="edit-mode" value="${item.supplier}" data-field="supplier" disabled></td>
          <td>
              <span class="display-mode">${item.shipmentType}</span>
              <select class="edit-mode" data-field="shipmentType" disabled>
                  <option value="امانی" ${item.shipmentType === 'امانی' ? 'selected' : ''}>امانی</option>
                  <option value="قطعی" ${item.shipmentType === 'قطعی' ? 'selected' : ''}>قطعی</option>
              </select>
          </td>
          <td><span class="display-mode">${item.date}</span><input type="text" class="edit-mode" value="${item.date}" data-field="date" disabled></td>
          <td>
              <span class="display-mode"><span class="status-badge ${statusClass}">${item.status}</span></span>
              <select class="edit-mode" data-field="status" disabled>
                  <option value="فعال" ${item.status === 'فعال' ? 'selected' : ''}>فعال</option>
                  <option value="غیرفعال" ${item.status === 'غیرفعال' ? 'selected' : ''}>غیرفعال</option>
              </select>
          </td>
          <td class="actions">
            <div class="actions-view">
                <button title="جزئیات" onclick="showShipmentDetails('${item.id}')"><i class="fa fa-eye"></i></button>
                <button title="ویرایش" onclick="editMainShipmentRow(this, '${item.id}')"><i class="fa fa-pen"></i></button>
                <button title="حذف" onclick="deleteMainShipmentRow(this, '${item.id}')"><i class="fa fa-trash"></i></button>
            </div>
            <div class="actions-edit">
                <button class="btn-save-row" title="ذخیره" onclick="saveEditedMainShipmentRow(this, '${item.id}')"><i class="fa fa-save"></i> ذخیره</button>
                <button class="btn-cancel-row" title="لغو" onclick="cancelEditMainShipmentRow(this, '${item.id}')"><i class="fa fa-times"></i> لغو</button>
            </div>
          </td>
        `;

        tableBody.appendChild(row);
      });
    }

    // مدیریت فایل Excel برای ثبت محموله (عملیات قبلی)
    function handleExcelFile(input) {
      const fileName = input.files[0] ? input.files[0].name : '';
      document.getElementById('excelFileName').textContent = fileName ? `فایل انتخاب شده: ${fileName}` : '';
      document.getElementById('uploadExcelBtn').style.display = fileName ? 'inline-block' : 'none';
    }

    // دانلود فایل نمونه برای ثبت محموله (عملیات قبلی)
    function downloadTemplate() {
      const csvContent = "شماره حواله,شرح حواله,تامین کننده,نوع ارسال,تاریخ,وضعیت\nSHP-10046,کوئیک پلاس نقره‌ای,شرکت نمونه,امانی,۱۴۰۴/۰۸/۲۵,فعال\nSHP-10047,شاهین سفید,شرکت تست,قطعی,۱۴۰۴/۰۸/۲۶,فعال";

      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'نمونه_محموله_خودرو.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // آپلود داده‌های Excel برای ثبت محموله (عملیات قبلی)
    function uploadExcelData() {
      const fileInput = document.getElementById('excelFile');
      if (!fileInput.files[0]) {
        alert('لطفاً ابتدا فایل را انتخاب کنید!');
        return;
      }
      alert('فایل Excel محموله با موفقیت پردازش شد! (در نسخه واقعی داده‌ها استخراج و ثبت می‌شوند)');
      fileInput.value = '';
      document.getElementById('excelFileName').textContent = '';
      document.getElementById('uploadExcelBtn').style.display = 'none';
      showMainPage();
    }

    // ----------------------------------------------------
    // توابع جدید برای مدیریت خودروها در صفحه جزئیات محموله
    // ----------------------------------------------------

    // Toggle (show/hide) single vehicle add form
    function toggleAddVehicleForm() {
        const formContainer = document.getElementById('singleVehicleAddFormContainer');
        const excelContainer = document.getElementById('fileVehicleAddContainer');
        const toggleBtn = document.getElementById('toggleAddVehicleFormBtn');
        const toggleExcelBtn = document.getElementById('toggleExcelVehicleAddBtn');

        if (formContainer.style.display === 'block') {
            formContainer.style.display = 'none';
            toggleBtn.querySelector('i').className = 'fa fa-plus'; // Change icon back to plus
        } else {
            formContainer.style.display = 'block';
            excelContainer.style.display = 'none'; // Hide excel section if single add form is shown
            toggleBtn.querySelector('i').className = 'fa fa-minus'; // Change icon to minus
            toggleExcelBtn.querySelector('i').className = 'fa fa-file-excel'; // Reset icon for excel button
            resetNewVehicleForm(); // Clear the form when it's opened
        }
    }

    // Toggle (show/hide) Excel vehicle add section
    function toggleExcelVehicleAdd() {
        const formContainer = document.getElementById('singleVehicleAddFormContainer');
        const excelContainer = document.getElementById('fileVehicleAddContainer');
        const toggleBtn = document.getElementById('toggleAddVehicleFormBtn');
        const toggleExcelBtn = document.getElementById('toggleExcelVehicleAddBtn');

        if (excelContainer.style.display === 'block') {
            excelContainer.style.display = 'none';
            toggleExcelBtn.querySelector('i').className = 'fa fa-file-excel'; // Change icon back to excel
        } else {
            excelContainer.style.display = 'block';
            formContainer.style.display = 'none'; // Hide single add form if excel section is shown
            toggleExcelBtn.querySelector('i').className = 'fa fa-minus'; // Change icon to minus
            toggleBtn.querySelector('i').className = 'fa fa-plus'; // Reset icon for single add button
            
            document.getElementById('excelVehicleFile').value = ''; // Clear selected file
            document.getElementById('excelVehicleFileName').textContent = '';
            document.getElementById('uploadVehicleExcelBtn').style.display = 'none';
        }
    }

    // Hide all vehicle add sections (used when returning to main page or opening details)
    function hideAllVehicleAddSections() {
        document.getElementById('singleVehicleAddFormContainer').style.display = 'none';
        document.getElementById('fileVehicleAddContainer').style.display = 'none';
        document.getElementById('toggleAddVehicleFormBtn').querySelector('i').className = 'fa fa-plus';
        document.getElementById('toggleExcelVehicleAddBtn').querySelector('i').className = 'fa fa-file-excel';
    }


    // پاک کردن فرم ثبت تکی خودرو
    function resetNewVehicleForm() {
        document.getElementById('singleVehicleForm').reset();
        // Generate a new ID for the new vehicle form when reset
        document.getElementById('newVehicleId').value = 'VEH-' + (Math.floor(Math.random() * 900000) + 100000); // Simple random unique ID
        document.getElementById('newQuantity').value = '1';
        document.getElementById('newUnit').value = 'دستگاه';
        document.getElementById('newPriceInfoUnknown').value = 'خیر';
        document.getElementById('newInsuranceInfoUnknown').value = 'خیر';
        document.getElementById('newMileageInfoUnknown').value = 'خیر';
        // Auto-fill header based on current shipment and number of existing vehicles
        document.getElementById('newVehicleHeader').value = currentShipmentForDetails ? currentShipmentForDetails.id + '-' + (currentShipmentForDetails.vehicles.length + 1) : '';
    }

    // ثبت فرم تکی خودرو جدید به محموله جاری
    document.getElementById('singleVehicleForm').addEventListener('submit', function(e) {
      e.preventDefault();

      if (!currentShipmentForDetails) {
        alert('خطا: محموله جاری برای افزودن خودرو انتخاب نشده است.');
        return;
      }

      // Check if vehicleId is already used in current shipment (though it's auto-generated)
      const newVehicleId = document.getElementById('newVehicleId').value;
      if (currentShipmentForDetails.vehicles.some(v => v.vehicleId === newVehicleId)) {
          // Regenerate if by chance it's duplicated (highly unlikely with random number)
          document.getElementById('newVehicleId').value = 'VEH-' + (Math.floor(Math.random() * 900000) + 100000);
          alert('شناسه خودرو تکراری است. لطفاً دوباره تلاش کنید.');
          return;
      }

      const newVehicle = {
        vehicleId: newVehicleId,
        header: document.getElementById('newVehicleHeader').value,
        vehicleStatus: document.getElementById('newVehicleStatus').value,
        appraisalPrice: toEnglishNumbers(document.getElementById('newAppraisalPrice').value),
        otherCostsOption: toEnglishNumbers(document.getElementById('newOtherCostsOption').value),
        otherCostsViolation: toEnglishNumbers(document.getElementById('newOtherCostsViolation').value),
        otherCostsMaintenance: toEnglishNumbers(document.getElementById('newOtherCostsMaintenance').value),
        otherCostsTransport: toEnglishNumbers(document.getElementById('newOtherCostsTransport').value),
        otherCostsMunicipalTax: toEnglishNumbers(document.getElementById('newOtherCostsMunicipalTax').value),
        finalPrice: toEnglishNumbers(document.getElementById('newFinalPrice').value),
        pyramidNumber: document.getElementById('newPyramidNumber').value,
        carName: document.getElementById('newCarName').value,
        carGroup: document.getElementById('newCarGroup').value,
        damageDescription: document.getElementById('newDamageDescription').value,
        engineIssues: document.getElementById('newEngineIssues').value,
        bodyIssues: document.getElementById('newBodyIssues').value,
        parkingLocation: document.getElementById('newParkingLocation').value,
        priceGuide: document.getElementById('newPriceGuide').value,
        priceInfoUnknown: document.getElementById('newPriceInfoUnknown').value,
        quantity: toEnglishNumbers(document.getElementById('newQuantity').value),
        unit: document.getElementById('newUnit').value,
        depositAmount: toEnglishNumbers(document.getElementById('newDepositAmount').value),
        minBidPrice: toEnglishNumbers(document.getElementById('newMinBidPrice').value),
        maxSalePrice: toEnglishNumbers(document.getElementById('newMaxSalePrice').value),
        buildNumber: document.getElementById('newBuildNumber').value,
        chassis: document.getElementById('newChassis').value,
        engine: document.getElementById('newEngine').value,
        year: toEnglishNumbers(document.getElementById('newYear').value),
        color: document.getElementById('newColor').value,
        plate: document.getElementById('newPlate').value,
        insuranceEndDate: document.getElementById('newInsuranceEndDate').value,
        insuranceInfoUnknown: document.getElementById('newInsuranceInfoUnknown').value,
        mileage: toEnglishNumbers(document.getElementById('newMileage').value),
        mileageInfoUnknown: document.getElementById('newMileageInfoUnknown').value,
      };

      currentShipmentForDetails.vehicles.push(newVehicle);
      renderVehicleDetailsTable(currentShipmentForDetails.vehicles); // Re-render table with new vehicle
      alert('خودروی جدید با موفقیت به محموله اضافه شد!');
      resetNewVehicleForm(); // Clear form after submission
      toggleAddVehicleForm(); // Collapse the form after successful submission
    });

    // مدیریت فایل Excel برای ثبت خودرو
    function handleExcelVehicleFile(input) {
      const fileName = input.files[0] ? input.files[0].name : '';
      document.getElementById('excelVehicleFileName').textContent = fileName ? `فایل انتخاب شده: ${fileName}` : '';
      document.getElementById('uploadVehicleExcelBtn').style.display = fileName ? 'inline-block' : 'none';
    }

    // دانلود فایل نمونه Excel برای خودروها
    function downloadVehicleTemplate() {
      const vehicleCsvHeaders = "هدر محموله,وضعیت خودرو,قیمت کارشناسی سایپا,هزینه آپشن,هزینه خلافی,هزینه تعمیر و نگهداری,هزینه حمل و نقل,هزینه عوارض شهرداری,بهای تمام شده,شماره هرم,نام خودرو,گروه خودرو,توضیحات محل آسیب دیده خودرو,ایرادات موتور خودرو,ایرادات بدنه,موقعیت پارکینگ,راهنمای ثبت قیمت,اطلاعی ندارم (قیمت),تعداد,واحد شمارش,مبلغ سپرده,حداقل قیمت پیشنهادی,حداکثر قیمت فروش,شماره ساخت,شاسی,موتور,سال,رنگ,پلاک,تاریخ اتمام بیمه,اطلاعی ندارم (بیمه),کیلومتر,اطلاعی ندارم (کیلومتر)\n";
      const sampleVehicleData = `SHP-10045-3,پارکینگ,880000000,0,0,10000000,1500000,30000,891530000,A-125,ساینا,سایپا,بدون آسیب,بدون ایراد,سالم,پارکینگ ۱، ردیف ۱,قیمت توافقی,خیر,1,دستگاه,40000000,850000000,920000000,BN-9876,CH-QWE-12345,EN-GHI-67890,1397,نقره‌ای,ایران ۳۳-۹۹۹ ب ۰۰,۱۴۰۵/۱۰/۰۱,خیر,150000,خیر\n`;
      const csvContent = vehicleCsvHeaders + sampleVehicleData;

      const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'نمونه_جزئیات_خودرو.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // آپلود داده‌های Excel برای خودروها
    function uploadVehicleExcelData() {
      const fileInput = document.getElementById('excelVehicleFile');
      if (!fileInput.files[0]) {
        alert('لطفاً ابتدا فایل را انتخاب کنید!');
        return;
      }
      if (!currentShipmentForDetails) {
        alert('خطا: محموله جاری برای افزودن خودرو انتخاب نشده است.');
        return;
      }

      // In a real application, you would parse the Excel file here (e.g., using a library like SheetJS)
      // For demonstration, we'll simulate adding some dummy data
      const simulatedNewVehicles = [
        {
            vehicleId: 'VEH-' + (Math.floor(Math.random() * 900000) + 100000), // unique ID
            header: currentShipmentForDetails.id + '-Batch-A1',
            vehicleStatus: 'پارکینگ',
            appraisalPrice: '700000000',
            otherCostsOption: '0', otherCostsViolation: '0', otherCostsMaintenance: '5000000',
            otherCostsTransport: '1000000', otherCostsMunicipalTax: '20000', finalPrice: '706020000',
            pyramidNumber: 'B-101', carName: 'پراید ۱۳۲', carGroup: 'گروه سایپا',
            damageDescription: 'گلگیر جلو رنگ دارد', engineIssues: 'بدون ایراد', bodyIssues: 'سالم',
            parkingLocation: 'پارکینگ A1', priceGuide: 'قیمت توافقی', priceInfoUnknown: 'خیر',
            quantity: '1', unit: 'دستگاه', depositAmount: '30000000',
            minBidPrice: '650000000', maxSalePrice: '750000000',
            buildNumber: 'ABC-123', chassis: 'CH-ABC-123', engine: 'EN-ABC-123',
            year: '1397', color: 'سفید', plate: 'ایران ۹۹-۸۷۶ د ۵۴',
            insuranceEndDate: '۱۴۰۴/۱۰/۰۱', insuranceInfoUnknown: 'خیر', mileage: '180000', mileageInfoUnknown: 'خیر'
        },
        {
            vehicleId: 'VEH-' + (Math.floor(Math.random() * 900000) + 100000), // unique ID
            header: currentShipmentForDetails.id + '-Batch-A2',
            vehicleStatus: 'مزایده',
            appraisalPrice: '1200000000',
            otherCostsOption: '1000000', otherCostsViolation: '50000', otherCostsMaintenance: '7000000',
            otherCostsTransport: '1800000', otherCostsMunicipalTax: '40000', finalPrice: '1209840000',
            pyramidNumber: 'C-202', carName: 'شاهین پلاس', carGroup: 'گروه سایپا',
            damageDescription: 'سقف کمی آفتاب سوختگی', engineIssues: 'نیاز به تعویض فیلتر', bodyIssues: 'سالم',
            parkingLocation: 'پارکینگ B2', priceGuide: 'مزایده علنی', priceInfoUnknown: 'خیر',
            quantity: '1', unit: 'دستگاه', depositAmount: '80000000',
            minBidPrice: '1100000000', maxSalePrice: '1300000000',
            buildNumber: 'DEF-456', chassis: 'CH-DEF-456', engine: 'EN-DEF-456',
            year: '1400', color: 'خاکستری', plate: 'ایران ۷۷-۵۴۳ س ۲۱',
            insuranceEndDate: '۱۴۰۴/۱۰/۰۱', insuranceInfoUnknown: 'خیر', mileage: '60000', mileageInfoUnknown: 'خیر'
        }
      ];

      currentShipmentForDetails.vehicles.push(...simulatedNewVehicles);
      renderVehicleDetailsTable(currentShipmentForDetails.vehicles);

      alert('فایل Excel جزئیات خودرو با موفقیت پردازش شد! (خودروهای نمونه اضافه شدند)');

      fileInput.value = '';
      document.getElementById('excelVehicleFileName').textContent = '';
      document.getElementById('uploadVehicleExcelBtn').style.display = 'none';
      toggleExcelVehicleAdd(); // Collapse the Excel section after upload
    }

    // ----------------------------------------------------
    // توابع ویرایش/حذف سطر در جدول اصلی محموله‌ها
    // ----------------------------------------------------
    
    // Function to enable editing for a specific main shipment row
    function editMainShipmentRow(buttonElement, shipmentId) {
        if (currentEditingMainShipmentId) {
            alert('لطفاً ابتدا ویرایش محموله قبلی را ذخیره یا لغو کنید.');
            return;
        }

        const row = buttonElement.closest('tr');
        currentEditingMainShipmentId = shipmentId;
        row.classList.add('editing');

        row.querySelector('.actions-view').style.display = 'none';
        row.querySelector('.actions-edit').style.display = 'flex';

        row.querySelectorAll('.edit-mode').forEach(input => {
            input.removeAttribute('disabled');
            input.style.display = 'block';
            if (input.previousElementSibling && input.previousElementSibling.classList.contains('display-mode')) {
                input.previousElementSibling.style.display = 'none';
            }
        });
        // Special handling for the Status badge, hide it when editing
        const statusSpan = row.querySelector('.status-badge');
        if(statusSpan) statusSpan.style.display = 'none';

        // Disable 'Details' button for other rows while one is being edited
        document.querySelectorAll('#dataTable .actions .fa-eye').forEach(btn => btn.closest('button').setAttribute('disabled', 'true'));
    }

    // Function to save changes for an edited main shipment row
    function saveEditedMainShipmentRow(buttonElement, shipmentId) {
        const row = buttonElement.closest('tr');
        if (shipmentId !== currentEditingMainShipmentId) {
            alert('خطا در ذخیره سازی: سطر در حال ویرایش نیست.');
            return;
        }

        const shipmentIndex = shipmentData.findIndex(s => s.id === shipmentId);
        if (shipmentIndex === -1) {
            alert('خطا: محموله مورد نظر یافت نشد.');
            cancelEditMainShipmentRow(buttonElement, shipmentId);
            return;
        }

        const updatedShipmentData = {};
        row.querySelectorAll('.edit-mode').forEach(input => {
            const field = input.getAttribute('data-field');
            updatedShipmentData[field] = input.value;
        });

        // Update the original shipment object in the data array
        Object.assign(shipmentData[shipmentIndex], updatedShipmentData);

        alert('تغییرات محموله با موفقیت ذخیره شد! (در حافظه موقت مرورگر)');
        // In a real application, send updatedShipmentData to the server

        currentEditingMainShipmentId = null;
        updateTable(); // Re-render the main table to reflect changes and reset view
        // Re-enable 'Details' buttons
        document.querySelectorAll('#dataTable .actions .fa-eye').forEach(btn => btn.closest('button').removeAttribute('disabled'));
    }

    // Function to cancel editing for a main shipment row
    function cancelEditMainShipmentRow(buttonElement, shipmentId) {
        if (shipmentId !== currentEditingMainShipmentId) {
            alert('خطا در لغو: سطر در حال ویرایش نیست.');
            return;
        }

        currentEditingMainShipmentId = null;
        updateTable(); // Re-render the main table to revert changes
        // Re-enable 'Details' buttons
        document.querySelectorAll('#dataTable .actions .fa-eye').forEach(btn => btn.closest('button').removeAttribute('disabled'));
    }

    // Function to delete a main shipment row
    function deleteMainShipmentRow(buttonElement, shipmentId) {
        if (currentEditingMainShipmentId) {
            alert('لطفاً ابتدا ویرایش محموله جاری را ذخیره یا لغو کنید.');
            return;
        }

        if (!confirm('آیا مطمئن هستید که می‌خواهید این محموله را حذف کنید؟')) {
            return;
        }

        const shipmentIndex = shipmentData.findIndex(s => s.id === shipmentId);
        if (shipmentIndex > -1) {
            shipmentData.splice(shipmentIndex, 1); // Remove from array
            updateTable(); // Re-render table
            alert('محموله با موفقیت حذف شد!');
            // In a real application, send deletion request to the server
        } else {
            alert('خطا: محموله مورد نظر برای حذف یافت نشد.');
        }
    }


    // ----------------------------------------------------
    // توابع ویرایش/حذف سطر در جدول جزئیات خودرو (صفحه جزئیات)
    // ----------------------------------------------------
    
    // Function to enable editing for a specific vehicle row
    function editVehicleRow(buttonElement, vehicleId) {
        if (editingVehicleRow) {
            alert('لطفاً ابتدا ویرایش سطر قبلی خودرو را ذخیره یا لغو کنید.');
            return;
        }

        const row = buttonElement.closest('tr');
        editingVehicleRow = row; // Set the current editing row
        row.classList.add('editing'); // Add class for styling

        // Hide view actions, show edit actions
        row.querySelector('.actions-view').style.display = 'none';
        row.querySelector('.actions-edit').style.display = 'flex';

        // Enable inputs/selects for editing
        row.querySelectorAll('.edit-mode').forEach(input => {
            input.removeAttribute('disabled');
            // Hide display mode elements and show edit mode elements
            input.style.display = 'block';
            if (input.previousElementSibling && input.previousElementSibling.classList.contains('display-mode')) {
                input.previousElementSibling.style.display = 'none';
            }
        });
    }

    // Function to save changes for an edited vehicle row
    function saveEditedVehicleRow(buttonElement, vehicleId) {
        const row = buttonElement.closest('tr');
        if (row !== editingVehicleRow) {
            alert('خطا در ذخیره سازی: سطر در حال ویرایش نیست.');
            return;
        }

        const vehicleIndex = currentShipmentForDetails.vehicles.findIndex(v => v.vehicleId === vehicleId);
        if (vehicleIndex === -1) {
            alert('خطا: خودرو مورد نظر یافت نشد.');
            cancelEditVehicleRow(buttonElement, vehicleId); // Cancel editing
            return;
        }

        const updatedVehicleData = {};
        row.querySelectorAll('.edit-mode').forEach(input => {
            const field = input.getAttribute('data-field');
            let value = input.value;

            // Convert to English numbers before saving
            if (['appraisalPrice', 'otherCostsOption', 'otherCostsViolation', 'otherCostsMaintenance', 'otherCostsTransport', 'otherCostsMunicipalTax', 'finalPrice', 'quantity', 'depositAmount', 'minBidPrice', 'maxSalePrice', 'mileage', 'year'].includes(field)) {
                value = toEnglishNumbers(value);
                if (value === '') {
                    value = '0';
                }
            }
            updatedVehicleData[field] = value;
        });

        // Update the original vehicle object in the data array
        Object.assign(currentShipmentForDetails.vehicles[vehicleIndex], updatedVehicleData);

        alert('تغییرات خودرو با موفقیت ذخیره شد! (در حافظه موقت مرورگر)');
        // In a real application, send updatedVehicleData to the server
        // fetch('/api/updateVehicle', { ... body: JSON.stringify(updatedVehicleData) })

        // Re-render the table to reflect changes and reset view
        renderVehicleDetailsTable(currentShipmentForDetails.vehicles);
        editingVehicleRow = null; // Clear editing state
    }

    // Function to cancel editing for a vehicle row
    function cancelEditVehicleRow(buttonElement, vehicleId) {
        const row = buttonElement.closest('tr');
        if (row !== editingVehicleRow) {
            alert('خطا در لغو: سطر در حال ویرایش نیست.');
            return;
        }
        
        // Re-render the table to revert changes
        renderVehicleDetailsTable(currentShipmentForDetails.vehicles);
        editingVehicleRow = null; // Clear editing state
    }

    // Function to delete a vehicle row
    function deleteVehicleRow(buttonElement, vehicleId) {
        if (!confirm('آیا مطمئن هستید که می‌خواهید این خودرو را حذف کنید؟')) {
            return;
        }

        if (editingVehicleRow) {
            alert('لطفاً ابتدا ویرایش سطر خودرو را ذخیره یا لغو کنید.');
            return;
        }

        const vehicleIndex = currentShipmentForDetails.vehicles.findIndex(v => v.vehicleId === vehicleId);
        if (vehicleIndex > -1) {
            currentShipmentForDetails.vehicles.splice(vehicleIndex, 1); // Remove from array
            renderVehicleDetailsTable(currentShipmentForDetails.vehicles); // Re-render table
            alert('خودرو با موفقیت حذف شد!');
            // In a real application, send deletion request to the server
            // fetch('/api/deleteVehicle/' + vehicleId, { method: 'DELETE' })
        } else {
            alert('خطا: خودرو مورد نظر برای حذف یافت نشد.');
        }
    }

    // Function to handle vehicle image upload (placeholder)
    function uploadVehicleImage(vehicleId) {
        alert(`قابلیت آپلود عکس برای خودروی با شناسه ${vehicleId} (در پیاده‌سازی واقعی یک مودال باز می‌شود).`);
        // Implement modal/file input for image upload here
    }

    // مقداردهی اولیه
    document.addEventListener('DOMContentLoaded', function() {
      // Set register date for new shipment form
      const registerDateInput = document.getElementById('registerDate');
      if (registerDateInput) {
        registerDateInput.value = getCurrentPersianDate();
        registerDateInput.setAttribute('readonly', 'true'); // Ensure it's readonly
      }
      updateTable(); // Populate the main table on load
    });
  </script>
</body>
</html>